{% extends "base.html" %}

{% block title %}Health Monitoring - Alpha Panda{% endblock %}

{% block content %}
<div x-data="healthDashboard()" class="space-y-6">
    <!-- Health Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">Overall Health</div>
                <div class="stat-value" :class="{
                    'text-success': overallHealth === 'healthy',
                    'text-warning': overallHealth === 'degraded',
                    'text-error': overallHealth === 'unhealthy'
                }" x-text="overallHealth || 'loading'"></div>
                <div class="stat-desc" x-text="healthSummary"></div>
            </div>
        </div>
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">Services</div>
                <div class="stat-value" x-text="serviceCount.healthy || 0"></div>
                <div class="stat-desc" x-text="`of ${serviceCount.total || 0} healthy`"></div>
            </div>
        </div>
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">Last Check</div>
                <div class="stat-value text-sm" x-text="lastHealthCheck || 'Never'"></div>
                <div class="stat-desc">Auto-refresh every 10s</div>
            </div>
        </div>
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">Uptime</div>
                <div class="stat-value text-success">99.9%</div>
                <div class="stat-desc">Last 24 hours</div>
            </div>
        </div>
    </div>

    <!-- Component Health Status -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Component Health Status</h2>
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Status</th>
                            <th>Last Check</th>
                            <th>Response Time</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="health-matrix">
                        <template x-for="component in healthComponents" :key="component.name">
                            <tr>
                                <td>
                                    <div class="flex items-center">
                                        <span x-text="component.icon" class="mr-2"></span>
                                        <span x-text="component.name"></span>
                                    </div>
                                </td>
                                <td>
                                    <div class="badge" :class="{
                                        'badge-success': component.status === 'healthy',
                                        'badge-warning': component.status === 'degraded',
                                        'badge-error': component.status === 'unhealthy'
                                    }" x-text="component.status"></div>
                                </td>
                                <td x-text="component.lastCheck"></td>
                                <td x-text="component.responseTime"></td>
                                <td>
                                    <div class="dropdown dropdown-end">
                                        <label tabindex="0" class="btn btn-ghost btn-xs">Details</label>
                                        <div tabindex="0" class="dropdown-content z-[1] card card-compact w-64 p-2 shadow bg-base-100">
                                            <div class="card-body">
                                                <template x-for="(value, key) in component.details" :key="key">
                                                    <div class="text-xs">
                                                        <span class="font-semibold" x-text="key + ':'"></span>
                                                        <span x-text="value"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Resources -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title">CPU Usage</h3>
                <div class="flex items-center justify-center h-32">
                    <div class="radial-progress text-primary text-xl" :style="`--value:${cpuUsage}`" :class="{
                        'text-success': cpuUsage < 70,
                        'text-warning': cpuUsage >= 70 && cpuUsage < 90,
                        'text-error': cpuUsage >= 90
                    }">
                        <span x-text="`${cpuUsage}%`"></span>
                    </div>
                </div>
                <div class="text-center text-sm opacity-70">
                    <span x-text="cpuUsage < 70 ? 'Normal' : cpuUsage < 90 ? 'High' : 'Critical'"></span>
                </div>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title">Memory Usage</h3>
                <div class="flex items-center justify-center h-32">
                    <div class="radial-progress text-secondary text-xl" :style="`--value:${memoryUsage}`" :class="{
                        'text-success': memoryUsage < 80,
                        'text-warning': memoryUsage >= 80 && memoryUsage < 95,
                        'text-error': memoryUsage >= 95
                    }">
                        <span x-text="`${memoryUsage}%`"></span>
                    </div>
                </div>
                <div class="text-center text-sm opacity-70">
                    <span x-text="memoryUsage < 80 ? 'Normal' : memoryUsage < 95 ? 'High' : 'Critical'"></span>
                </div>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title">Disk Usage</h3>
                <div class="flex items-center justify-center h-32">
                    <div class="radial-progress text-accent text-xl" :style="`--value:${diskUsage}`" :class="{
                        'text-success': diskUsage < 85,
                        'text-warning': diskUsage >= 85 && diskUsage < 95,
                        'text-error': diskUsage >= 95
                    }">
                        <span x-text="`${diskUsage}%`"></span>
                    </div>
                </div>
                <div class="text-center text-sm opacity-70">
                    <span x-text="diskUsage < 85 ? 'Normal' : diskUsage < 95 ? 'High' : 'Critical'"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Health History Chart -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">Health History</h2>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-outline" @click="toggleAutoRefresh()">
                        <span x-text="autoRefresh ? 'Pause' : 'Resume'"></span>
                    </button>
                    <button class="btn btn-sm btn-outline" @click="exportHealthData()">Export</button>
                </div>
            </div>
            <canvas id="healthChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Health Alerts -->
    <div class="card bg-base-100 shadow-xl" x-show="healthAlerts.length > 0">
        <div class="card-body">
            <h2 class="card-title text-warning">Health Alerts</h2>
            <div class="space-y-2">
                <template x-for="alert in healthAlerts" :key="alert.id">
                    <div class="alert" :class="{
                        'alert-warning': alert.severity === 'warning',
                        'alert-error': alert.severity === 'error',
                        'alert-info': alert.severity === 'info'
                    }">
                        <div class="flex justify-between items-center w-full">
                            <div>
                                <span class="font-semibold" x-text="alert.component"></span>:
                                <span x-text="alert.message"></span>
                            </div>
                            <div class="text-xs opacity-70" x-text="alert.timestamp"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ request.state.csp_nonce }}">
function healthDashboard() {
    return {
        overallHealth: 'loading',
        healthSummary: '',
        lastHealthCheck: null,
        cpuUsage: 0,
        memoryUsage: 0,
        diskUsage: 0,
        healthChart: null,
        autoRefresh: true,
        serviceCount: { healthy: 0, total: 0 },
        healthComponents: [],
        healthAlerts: [],
        
        init() {
            this.initHealthChart();
            this.startHealthMonitoring();
        },
        
        initHealthChart() {
            const ctx = document.getElementById('healthChart').getContext('2d');
            this.healthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'System Health Score',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true
                    }, {
                        label: 'CPU Usage %',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }, {
                        label: 'Memory Usage %',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        },
        
        startHealthMonitoring() {
            if (!this.autoRefresh) return;
            
            // Connect to SSE for real-time health updates
            const eventSource = new EventSource('/dashboard/events/health');
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.updateHealthMetrics(data);
            };
            
            eventSource.onerror = () => {
                this.overallHealth = 'error';
                this.healthSummary = 'Connection error';
            };
        },
        
        updateHealthMetrics(data) {
            if (!data.data) return;
            
            // Update overall health
            const summary = data.data.summary;
            if (summary) {
                this.serviceCount.healthy = summary.healthy;
                this.serviceCount.total = summary.total_checks;
                
                if (summary.healthy === summary.total_checks) {
                    this.overallHealth = 'healthy';
                    this.healthSummary = 'All systems operational';
                } else if (summary.healthy >= summary.total_checks - 1) {
                    this.overallHealth = 'degraded';
                    this.healthSummary = `${summary.total_checks - summary.healthy} issue(s)`;
                } else {
                    this.overallHealth = 'unhealthy';
                    this.healthSummary = `${summary.total_checks - summary.healthy} critical issue(s)`;
                }
            }
            
            // Update system resource usage
            const checks = data.data.checks;
            if (checks) {
                if (checks.cpu_usage && checks.cpu_usage.details) {
                    this.cpuUsage = Math.round(checks.cpu_usage.details.cpu_percent);
                }
                
                if (checks.memory_usage && checks.memory_usage.details) {
                    this.memoryUsage = Math.round(checks.memory_usage.details.used_percent);
                }
                
                if (checks.disk_space && checks.disk_space.details) {
                    this.diskUsage = Math.round(checks.disk_space.details.used_percent);
                }
                
                // Update health components table
                this.updateHealthComponents(checks);
            }
            
            // Update timestamp
            this.lastHealthCheck = new Date().toLocaleTimeString();
            
            // Update health chart
            this.updateHealthChart(data);
            
            // Check for alerts
            this.checkHealthAlerts(data);
        },
        
        updateHealthComponents(checks) {
            this.healthComponents = [
                {
                    name: 'CPU',
                    icon: '🖥️',
                    status: this.cpuUsage < 70 ? 'healthy' : this.cpuUsage < 90 ? 'degraded' : 'unhealthy',
                    lastCheck: new Date().toLocaleTimeString(),
                    responseTime: '< 1ms',
                    details: {
                        'Usage': `${this.cpuUsage}%`,
                        'Cores': '8',
                        'Load Average': '0.5'
                    }
                },
                {
                    name: 'Memory',
                    icon: '🧠',
                    status: this.memoryUsage < 80 ? 'healthy' : this.memoryUsage < 95 ? 'degraded' : 'unhealthy',
                    lastCheck: new Date().toLocaleTimeString(),
                    responseTime: '< 1ms',
                    details: {
                        'Usage': `${this.memoryUsage}%`,
                        'Total': '16GB',
                        'Available': `${16 - Math.round(16 * this.memoryUsage / 100)}GB`
                    }
                },
                {
                    name: 'Disk',
                    icon: '💾',
                    status: this.diskUsage < 85 ? 'healthy' : this.diskUsage < 95 ? 'degraded' : 'unhealthy',
                    lastCheck: new Date().toLocaleTimeString(),
                    responseTime: '< 1ms',
                    details: {
                        'Usage': `${this.diskUsage}%`,
                        'Total': '1TB',
                        'Free': `${Math.round(1000 * (1 - this.diskUsage / 100))}GB`
                    }
                },
                {
                    name: 'Redis Cache',
                    icon: '🗄️',
                    status: checks.redis?.status || 'unknown',
                    lastCheck: new Date().toLocaleTimeString(),
                    responseTime: '< 5ms',
                    details: {
                        'Connection': 'Active',
                        'Keys': '1,234',
                        'Memory': '45MB'
                    }
                },
                {
                    name: 'Database',
                    icon: '🗃️',
                    status: checks.database?.status || 'healthy',
                    lastCheck: new Date().toLocaleTimeString(),
                    responseTime: '< 10ms',
                    details: {
                        'Connection': 'Active',
                        'Pool Size': '20',
                        'Active Connections': '5'
                    }
                }
            ];
        },
        
        updateHealthChart(data) {
            if (!this.healthChart) return;
            
            const now = new Date().toLocaleTimeString();
            const healthScore = this.calculateHealthScore(data);
            
            this.healthChart.data.labels.push(now);
            this.healthChart.data.datasets[0].data.push(healthScore);
            this.healthChart.data.datasets[1].data.push(this.cpuUsage);
            this.healthChart.data.datasets[2].data.push(this.memoryUsage);
            
            // Keep only last 20 data points
            if (this.healthChart.data.labels.length > 20) {
                this.healthChart.data.labels.shift();
                this.healthChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            this.healthChart.update();
        },
        
        calculateHealthScore(data) {
            if (!data.data || !data.data.summary) return 0;
            
            const summary = data.data.summary;
            const totalChecks = summary.total_checks || 1;
            const healthyChecks = summary.healthy || 0;
            
            return Math.round((healthyChecks / totalChecks) * 100);
        },
        
        checkHealthAlerts(data) {
            const alerts = [];
            
            // CPU alert
            if (this.cpuUsage > 90) {
                alerts.push({
                    id: 'cpu_critical',
                    component: 'CPU',
                    message: `Critical CPU usage: ${this.cpuUsage}%`,
                    severity: 'error',
                    timestamp: new Date().toLocaleTimeString()
                });
            } else if (this.cpuUsage > 70) {
                alerts.push({
                    id: 'cpu_warning',
                    component: 'CPU',
                    message: `High CPU usage: ${this.cpuUsage}%`,
                    severity: 'warning',
                    timestamp: new Date().toLocaleTimeString()
                });
            }
            
            // Memory alert
            if (this.memoryUsage > 95) {
                alerts.push({
                    id: 'memory_critical',
                    component: 'Memory',
                    message: `Critical memory usage: ${this.memoryUsage}%`,
                    severity: 'error',
                    timestamp: new Date().toLocaleTimeString()
                });
            } else if (this.memoryUsage > 80) {
                alerts.push({
                    id: 'memory_warning',
                    component: 'Memory',
                    message: `High memory usage: ${this.memoryUsage}%`,
                    severity: 'warning',
                    timestamp: new Date().toLocaleTimeString()
                });
            }
            
            // Disk alert
            if (this.diskUsage > 95) {
                alerts.push({
                    id: 'disk_critical',
                    component: 'Disk',
                    message: `Critical disk usage: ${this.diskUsage}%`,
                    severity: 'error',
                    timestamp: new Date().toLocaleTimeString()
                });
            }
            
            this.healthAlerts = alerts;
        },
        
        toggleAutoRefresh() {
            this.autoRefresh = !this.autoRefresh;
            if (this.autoRefresh) {
                this.startHealthMonitoring();
            }
        },
        
        exportHealthData() {
            const data = {
                timestamp: new Date().toISOString(),
                overall_health: this.overallHealth,
                system_resources: {
                    cpu_usage: this.cpuUsage,
                    memory_usage: this.memoryUsage,
                    disk_usage: this.diskUsage
                },
                components: this.healthComponents,
                alerts: this.healthAlerts
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alpha-panda-health-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }
}
</script>
{% endblock %}